# Home Assistant Add-on: Eseenet/dvr163 NVR

Accept "motion detection" emails from an Eseenet/dvr163 NVR and execute configurable actions with the data. 

## NVR Configuration

The NVR must send the emails to Home Assistant. From the main system menu go to `Network Setup` > `E-Mail` and use the following configuration. The `hass` user is required, replace the `SMTP Server` with the address of your home assistant: 

![image](https://user-images.githubusercontent.com/11710621/91005315-2c5a5d80-e59c-11ea-883c-3767ae463925.png)

If the add-on is running, the "Test" button should work and display in the logs. 

## Add-on Configuration

Example configuration with all actions enabled:

```yaml
log_level: 20
home_assistant:
  enabled: true
  post_to: services/script/handle_dvr163_email
dropbox:
  enabled: true
  access_token: aaaaaaBBBBBBccccccDDDDDDeeeeeeFFFFFFgggggg
email:
  enabled: true
  host: smtp.gmail.com
  port: 587
  username: user@gmail.com
  password: hunter2
```

`log_level` 
Python log level to use for the "Log" tab: 
0=NOTSET
10=DEBUG
20=INFO
30=WARN
40=ERROR
50=CRITICAL

`home_assistant.enabled`
Determine if motion detection emails should be sent to Home Assistant.

`home_assistant.post_to`
The Home Assistant API path to POST the message to. It will append this string to the HA proxy e.g. `http://supervisor/core/api/{POST_TO}` so the data can be sent wherever you want on the Home Assistant API. It is suggested to post to a custom script such as `services/script/handle_dvr163_email`. The script can then do things like write the file to disk, send notifications, etc.

`dropbox.enabled`
Determine if motion detection emails should be uploaded to Dropbox.

`dropbox.access_token`
The access token generated by Dropbox. When creating an access token it is suggested to create an "app" in Dropbox with access only limited to the app folder.

`email.enabled`
Determine if motion detection emails should be forwarded to another email address (only tested with Gmail). 

`email.host`
The host of the SMTP server to send to.

`email.port`
The port of the SMTP server to send to.

`email.username`
The username to log in with, send to, and send from.

`email.password`
The password to log in with, send to, and send from.


## Supported Actions: 

### Home Assistant
Parse the email and send a POST request to Home Assistant's API, such as to a [script](https://www.home-assistant.io/integrations/script/). The POST contains the following fields: 

* `channel_number` The channel sending the notification (1-4, or more depending on NVR)
* `image_data` A base64 encoded string of the image
* `message` The message from the email e.g. "Motion detect in video channel 4"
* `timestamp` The current system time (as opposed to the time provided in the email body)

```yaml
shelL_command:
    snapshot_to_disk: /bin/bash -c "echo '{{ image_data }}' | base64 -d > www/images/snapshot_cam_{{ channel_number }}.jpg"
```

### Dropbox
Upload the image to Dropbox. When creating an access token it is suggested to create an "app" in Dropbox with access only limited to the app folder. Images are saved with the following folder/naming convention: 
```
ch<channel number>/<date>/<time>.jpg
```
The date and time do not use system time, it uses whatever timestamp text is in the body of the email. This makes it easy to find the relevant video later since the time is synced with the NVR and is not impacted by network latency. 

### Email
Forward the email to another email address (only tested with Gmail). This is to maintain backwards compatability since the NVR is no longer sending emails to a true inbox. It also allows you to completely block the NVR from accessing the internet if desired e.g. at the router level. 

## How it works

The add-on is a single container that runs 2 services: 

* Postfix SMTP server (port 25)
* Python web server (port 8080)

The Python server is the main entrypoint process and contains all the logic, Postfix is used as a vehicle to receive emails and provide them to Python. The postfix server runs in the background. When it receives an email it will POST the contents to the `/api/email` endpoint of the Python web server. 

## Development

Based on https://developers.home-assistant.io/docs/add-ons/testing

Open the project directory in VS Code and "Reopen in Container" when prompted to open in dev container. This will open the project in a container that contains an instance of Home Assistant. Run the `Start Home Assistant` task to start Home Assistant, once running it is accessible at http://localhost:7123. Navigate to the Supervisor tab and install the `Eseenet/dvr163 NVR` add-on. From there you can make changes and click "Rebuild" from Home Assistant and the changes will be applied and can be tested live. 

### Debugging

There are launch configs for running the Python scripts in the container in VS Code with debug support. This technically does not require Home Assistant to be running but it is suggested to run the `Start Home Assistant` task because it starts Docker in the devcontainer which is needed to debug Python. There are 2 launch configs: 

1. Flask - Runs the main web server just like the full add-on (but without the Postfix SMTP server)
1. handle_email.py - Directly runs the email handler script with a test email

An `options.json` file with runtime configuration must be provided. When debugging it will look in `/app/dev/env/options.json`, otherwise it uses Home Assistant's default `/data/options.json` location. 
